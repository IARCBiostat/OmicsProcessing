---
title: "OmicsProcessing Overview"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{OmicsProcessing Overview}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

## Purpose

This vignette walks through a typical preprocessing flow for omics data using the `OmicsProcessing` package. It outlines how to prepare your input, perform quality control, and normalise features across batches or study strata.

## Installation

The package can be installed from the source repository:

```{r, eval = FALSE}
# install.packages("remotes")
remotes::install_github("farnudia/OmicsProcessing")
```

Then load the package:

```{r, eval = FALSE}
library(OmicsProcessing)
```

## Data preparation

Your input data frame should contain sample metadata (such as batch or study strata) and feature columns with numeric values. Missing values should be imputed or removed before normalization.

```{r, eval = FALSE}
# Example structure
head(my_data)
#   sample_id  strata   is_qc    feature1  feature2  ...
#   S1         BatchA   FALSE    1023      55
#   S2         BatchA   TRUE     1044      60
```

## Normalization with SERRF by batch/strata

Use `normalise_SERRF_by_batch()` to adjust unwanted variation while respecting batch or other stratification variables. The function now accepts `strata_col`, and will convert it to a factor internally if needed.

```{r, eval = FALSE}
normalized <- normalise_SERRF_by_batch(
  df = my_data,
  target_cols = tidyselect::starts_with("feature"),
  is_qc = my_data$is_qc,
  strata_col = "strata",
  num_screen_SERRF = 10
)
```

Key arguments:

- `target_cols`: character vector or tidyselect helper identifying feature columns to normalize.
- `is_qc`: logical vector marking QC samples.
- `strata_col`: column name for batches/strata; coerced to factor if not already.
- `num_screen_SERRF`: number of correlated features screened when fitting SERRF models.

## Downstream checks

After normalization, consider visual checks (e.g., PCA on QC samples) and simple summary statistics to ensure batch effects have been mitigated.

```{r, eval = FALSE}
library(ggplot2)
library(dplyr)

normalized %>%
  dplyr::filter(is_qc) %>%
  select(target_cols) %>%
  prcomp(scale. = TRUE) %>%
  broom::tidy(matrix = "u") %>%
  ggplot(aes(PC1, PC2, color = normalized$is_qc)) +
  geom_point()
```

This overview should help you integrate SERRF normalization and related preprocessing steps into your analysis workflow. See function documentation for additional options and details.
