---
title: "Batch correction using SERRF"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Batch correction using SERRF}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

## Step 5: Batch correction using SERRF

```{r eval=FALSE}
out_serrf <- OmicsProcessing::normalise_SERRF_by_batch(
  imputed_df,
  target_cols = "@",
  is_qc = grepl("^sQC", imputed_df$sample_type),
  strata_col = "batch"
)
```

`normalise_SERRF_by_batch()` models unwanted technical variation using
QC samples within each batch/stratum and applies SERRF normalization to
the specified feature columns. Use `target_cols` to select features by
name, tidyselect helper, or regex (resolved via
`resolve_target_cols()`), and supply a logical `is_qc` flag for each
row. See the reference:
[`normalise_SERRF_by_batch()`](../reference/normalise_SERRF_by_batch.html).

### Input requirements

- `strata_col` must exist in `df` (will be coerced to a factor if
  needed) with **no NA levels**.
- `is_qc` is a logical vector the same length as `nrow(df)`; ensure
  every batch has enough QC samples for the SERRF model.
- All `target_cols` must be numeric and **contain no NA values** (impute
  beforehand).

### Tuning and tips

- `num_screen_SERRF` (default 10) controls how many correlated features
  are screened per target; increase cautiously if you have many features
  and stable QC coverage.
- Inspect before/after QC CVs or PCA to verify batch drift is reduced.
- Keep batches balanced: very small batches or few QC points can lead to
  unstable fits; consider merging sparse strata or adding QC if
  possible.
