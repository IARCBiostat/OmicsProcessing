<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Feature clustering by retention time • OmicsProcessing</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Feature clustering by retention time">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">OmicsProcessing</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.1.4</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/data-filtering.html">Data filtering with filter_by_missingness()</a></li>
    <li><a class="dropdown-item" href="../articles/developer-guidelines.html">Developers &amp; Contributors</a></li>
    <li><a class="dropdown-item" href="../articles/feature-clustering.html">Feature clustering by retention time</a></li>
    <li><a class="dropdown-item" href="../articles/hybrid-imputation.html">Hybrid imputation with RF + LCMD</a></li>
    <li><a class="dropdown-item" href="../articles/log-transformation.html">Log transformation with log1p()</a></li>
    <li><a class="dropdown-item" href="../articles/outlier-removal.html">Outlier removal with remove_outliers()</a></li>
    <li><a class="dropdown-item" href="../articles/process_data.html">Semi-automated pipeline with process_data()</a></li>
    <li><a class="dropdown-item" href="../articles/serrf-normalisation.html">Batch correction using SERRF</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Feature clustering by retention time</h1>
            
      

      <div class="d-none name"><code>feature-clustering.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="cluster-features-by-retention-time">Cluster features by retention time<a class="anchor" aria-label="anchor" href="#cluster-features-by-retention-time"></a>
</h2>
<p><code><a href="../reference/cluster_features_by_retention_time.html">cluster_features_by_retention_time()</a></code> groups features
that elute together, based on similar retention times (RTs). It returns
a data frame that includes all unclustered features
<strong>unchanged</strong>, plus <strong>one representative per
cluster</strong>. The <code>representatives_map</code> output shows
which original features each representative corresponds to. See the
function reference for further details: <a href="../reference/cluster_features_by_retention_time.html"><code>cluster_features_by_retention_time()</code></a>.</p>
<blockquote>
<p><strong>Prerequisites:</strong> use <strong>imputed and
normalised</strong> data before applying RT clustering. This procedure
assumes no missing values and benefits from stabilised intensity
profiles.</p>
</blockquote>
<p>The <code>is_qc</code> argument prevents QC-designated rows from
contributing to the clustering. Typically, <code>is_qc</code> should be
set to <code>NULL</code> so that all samples contribute.</p>
<div class="section level3">
<h3 id="how-representatives-are-selected-with-the-scores-method">How representatives are selected with the “scores” method<a class="anchor" aria-label="anchor" href="#how-representatives-are-selected-with-the-scores-method"></a>
</h3>
<p>The “scores” method clusters features by RT and returns <strong>one
representative per RT cluster</strong> based on the input score. It
employs <a href="../reference/get_features_representatives_based_on_scores.html"><code>get_features_representatives_based_on_scores()</code></a>.
This helper is called internally by
<code><a href="../reference/cluster_features_by_retention_time.html">cluster_features_by_retention_time()</a></code>; you do not need to
invoke it explicitly.</p>
<p>For each RT-based cluster:</p>
<ul>
<li>Single-feature clusters: the feature is returned unchanged.</li>
<li>Multi-feature clusters: the feature with the <strong>highest
score</strong> is selected as the representative, and
<code>representatives_map</code> records all members that it
represents.</li>
</ul>
</div>
<div class="section level3">
<h3 id="example-1-score-based-representatives-mean-intensity-before-normalisation">Example 1: Score-based representatives (mean intensity before
normalisation)<a class="anchor" aria-label="anchor" href="#example-1-score-based-representatives-mean-intensity-before-normalisation"></a>
</h3>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Assume `imputed_df` is your imputed, SERRF-normalised data</span></span>
<span><span class="co"># Use pre-normalisation means as scores</span></span>
<span><span class="va">target_cols</span> <span class="op">&lt;-</span> <span class="fu">OmicsProcessing</span><span class="fu">::</span><span class="fu"><a href="../reference/resolve_target_cols.html">resolve_target_cols</a></span><span class="op">(</span><span class="va">clean_df</span>, <span class="st">"@"</span><span class="op">)</span></span>
<span><span class="va">scores</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="va">pre_normalised_df</span><span class="op">[</span>, <span class="va">target_cols</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="va">res_scores</span> <span class="op">&lt;-</span> <span class="fu">OmicsProcessing</span><span class="fu">::</span><span class="fu"><a href="../reference/cluster_features_by_retention_time.html">cluster_features_by_retention_time</a></span><span class="op">(</span></span>
<span>  df <span class="op">=</span> <span class="va">normalised_df</span>,</span>
<span>  target_cols <span class="op">=</span> <span class="va">target_cols</span>,</span>
<span>  rt_height <span class="op">=</span> <span class="fl">0.07</span>,</span>
<span>  method <span class="op">=</span> <span class="st">"scores"</span>,</span>
<span>  corr_thresh <span class="op">=</span> <span class="fl">0.75</span>,</span>
<span>  scores <span class="op">=</span> <span class="va">scores</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">clustered_df</span> <span class="op">&lt;-</span> <span class="va">res_scores</span><span class="op">$</span><span class="va">clustered_df</span>     <span class="co"># original features + representatives</span></span>
<span><span class="va">rep_map</span> <span class="op">&lt;-</span> <span class="va">res_scores</span><span class="op">$</span><span class="va">representatives_map</span>   <span class="co"># mapping of representatives to raw features</span></span></code></pre></div>
<p>The <code>rt_height</code> parameter defines the maximum RT span for
forming a cluster: features whose RTs differ by less than this value are
grouped. Within each RT‑based group, pairwise correlations between
features are calculated, and the features are further partitioned into
correlation‑based subclusters. The supplied <code>scores</code>
determine the representative feature for each subcluster. In this
example, pre-normalisation mean intensities serve as scores;
consequently, each representative is the feature with the highest mean
intensity before normalisation.</p>
<p>The <code>representatives_map</code> lists representatives as names,
with vectors of raw feature names as their values. In effect, features
with similar retention times are identified, and among those with high
correlation, the feature with the highest pre‑normalisation mean
intensity is selected as the representative.</p>
</div>
<div class="section level3">
<h3 id="how-representatives-are-selected-with-the-correlation-method">How representatives are selected with the correlation method<a class="anchor" aria-label="anchor" href="#how-representatives-are-selected-with-the-correlation-method"></a>
</h3>
<p>With <code>method = "correlations"</code>, the features are first
grouped together by the <code>rt_height</code> (like the scores method).
Then, a secondary correlation-based clustering step is applied within
each RT-defined group. Clustering behaviour is governed by
<code>corr_thresh</code> and <code>cut_height</code>:</p>
<ul>
<li><p>RT cluster of size 1: retained unchanged.</p></li>
<li>
<p>RT cluster of size 2:</p>
<ul>
<li>If <code>|corr| ≥ corr_thresh</code>, the pair is summarised as a
synthetic PC1 feature.</li>
<li>Otherwise, both features are retained.</li>
</ul>
</li>
<li><p>RT cluster of size ≥3: hierarchical clustering (ClustOfVar) is
cut at <code>cut_height</code>, and each resulting sub-cluster is
summarised as a synthetic PC1, aligned to the first feature in that
sub-cluster.</p></li>
</ul>
<p>In all cases, the <code>representatives_map</code> lists synthetic
feature names and records the raw features incorporated into each
synthetic representative.</p>
</div>
<div class="section level3">
<h3 id="example-2-correlation-based-summarisation-within-rt-clusters">Example 2: Correlation-based summarisation within RT clusters<a class="anchor" aria-label="anchor" href="#example-2-correlation-based-summarisation-within-rt-clusters"></a>
</h3>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">res_corr</span> <span class="op">&lt;-</span> <span class="fu">OmicsProcessing</span><span class="fu">::</span><span class="fu"><a href="../reference/cluster_features_by_retention_time.html">cluster_features_by_retention_time</a></span><span class="op">(</span></span>
<span>  df <span class="op">=</span> <span class="va">normalised_df</span>,</span>
<span>  target_cols <span class="op">=</span> <span class="st">"@"</span>,</span>
<span>  is_qc <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grepl</a></span><span class="op">(</span><span class="st">"^sQC"</span>, <span class="va">normalised_df</span><span class="op">$</span><span class="va">sample_type</span><span class="op">)</span>,</span>
<span>  rt_height <span class="op">=</span> <span class="fl">0.07</span>,</span>
<span>  method <span class="op">=</span> <span class="st">"correlations"</span>,</span>
<span>  cut_height <span class="op">=</span> <span class="fl">0.26</span>,</span>
<span>  corr_thresh <span class="op">=</span> <span class="fl">0.75</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">clustered_df_corr</span> <span class="op">&lt;-</span> <span class="va">res_corr</span><span class="op">$</span><span class="va">clustered_df</span></span>
<span><span class="va">rep_map_corr</span> <span class="op">&lt;-</span> <span class="va">res_corr</span><span class="op">$</span><span class="va">representatives_map</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="tips">Tips<a class="anchor" aria-label="anchor" href="#tips"></a>
</h3>
<ul>
<li>Set <code>rt_height</code> to reflect the instrument’s RT precision;
smaller values produce more, and tighter, RT clusters.</li>
<li>For <code>"scores"</code>, ensure that <code>scores</code> is a
<strong>named numeric vector</strong> aligned with
<code>target_cols</code>. Using pre-normalisation means is a simple and
efficient strategy.</li>
<li>For <code>"correlations"</code>, tune <code>cut_height</code> and
<code>corr_thresh</code> to adjust the merging stringency for correlated
features.</li>
<li>Always inspect the <code>representatives_map</code> to understand
how each representative relates to original features, particularly for
reporting, audit trails, or sensitivity analyses.</li>
</ul>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Vivian Viallon, Lee Matthew, Ali Farnudi.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
