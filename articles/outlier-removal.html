<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Outlier removal with remove_outliers() • OmicsProcessing</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Outlier removal with remove_outliers()">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">OmicsProcessing</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.1.1</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/data-filtering.html">Data filtering with filter_by_missingness()</a></li>
    <li><a class="dropdown-item" href="../articles/developer-guidelines.html">Developers &amp; Contributors</a></li>
    <li><a class="dropdown-item" href="../articles/feature-clustering.html">Feature clustering by retention time</a></li>
    <li><a class="dropdown-item" href="../articles/hybrid-imputation.html">Hybrid imputation with RF + LCMD</a></li>
    <li><a class="dropdown-item" href="../articles/log-transformation.html">Log transformation with log1p()</a></li>
    <li><a class="dropdown-item" href="../articles/outlier-removal.html">Outlier removal with remove_outliers()</a></li>
    <li><a class="dropdown-item" href="../articles/process_data.html">Semi-automated pipeline with process_data()</a></li>
    <li><a class="dropdown-item" href="../articles/serrf-normalisation.html">Batch correction using SERRF</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Outlier removal with remove_outliers()</h1>
            
      

      <div class="d-none name"><code>outlier-removal.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="outlier-removal-using-pca-lof">Outlier removal using PCA + LOF<a class="anchor" aria-label="anchor" href="#outlier-removal-using-pca-lof"></a>
</h2>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">outlier_results</span> <span class="op">&lt;-</span> <span class="fu">OmicsProcessing</span><span class="fu">::</span><span class="fu"><a href="../reference/remove_outliers.html">remove_outliers</a></span><span class="op">(</span></span>
<span>  <span class="va">filtered_df</span>,</span>
<span>  target_cols <span class="op">=</span> <span class="st">"@"</span>,</span>
<span>  is_qc <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grepl</a></span><span class="op">(</span><span class="st">"^sQC"</span>, <span class="va">filtered_df</span><span class="op">$</span><span class="va">sample_type</span><span class="op">)</span>,</span>
<span>  method <span class="op">=</span> <span class="st">"pca-lof-overall"</span>,</span>
<span>  impute_method <span class="op">=</span> <span class="st">"half-min-value"</span>,</span>
<span>  restore_missing_values <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  return_ggplots <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span>
<span><span class="va">clean_df</span> <span class="op">&lt;-</span> <span class="va">outlier_results</span><span class="op">$</span><span class="va">df_filtered</span></span></code></pre></div>
<p>This function detects and removes outliers from the dataset using a
PCA + Local Outlier Factor (LOF) workflow. Outliers are identified only
among non-QC samples. Missing values can be imputed temporarily for
detection, and original <code>NA</code>s can be restored afterward. If
<code>return_ggplots = TRUE</code>, PCA plots are returned (see notes
below). See <a href="../reference/remove_outliers.html"><code>remove_outliers()</code></a>.</p>
<div class="section level3">
<h3 id="optional-stratified-outlier-detection-strata">Optional: stratified outlier detection (<code>strata</code>)<a class="anchor" aria-label="anchor" href="#optional-stratified-outlier-detection-strata"></a>
</h3>
<p>By default, <strong>no stratification</strong> is used (all non-QC
samples are assessed together). You can optionally provide a
<strong>stratification variable</strong> so that outlier detection runs
<strong>independently within each stratum</strong>, and results are then
merged:</p>
<ul>
<li>
<p>Supply <code>strata</code> as either:</p>
<ul>
<li>the <strong>name of a column</strong> in <code>df</code>, or</li>
<li>an <strong>external vector</strong> of length <code>nrow(df)</code>
(e.g., a custom grouping).</li>
</ul>
</li>
<li>
<p>Within each stratum:</p>
<ul>
<li>QC rows are <strong>excluded</strong> from detection (but always
kept in the final output).</li>
<li>If <code>impute_method = "half-min-value"</code>, imputation is
performed <strong>within that stratum</strong> on
<code>target_cols</code>.</li>
<li>PCA → LOF → Tukey thresholding are applied to identify
outliers.</li>
</ul>
</li>
<li><p>The function returns the union of outlier sample IDs across
strata and removes only those from the non-QC portion before recombining
with QC rows.</p></li>
<li><p>When <code>return_ggplots = TRUE</code>, you’ll get a
<strong>named list of per-stratum plots</strong> in
<code>outlier_results$plot_samples_outlier</code>.</p></li>
</ul>
<p><strong>Examples</strong></p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## 1) No stratification (default)</span></span>
<span><span class="va">res</span> <span class="op">&lt;-</span> <span class="fu">OmicsProcessing</span><span class="fu">::</span><span class="fu"><a href="../reference/remove_outliers.html">remove_outliers</a></span><span class="op">(</span></span>
<span>  <span class="va">df</span>, </span>
<span>  target_cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"f1"</span>,<span class="st">"f2"</span>,<span class="st">"f3"</span><span class="op">)</span>,</span>
<span>  is_qc <span class="op">=</span> <span class="va">df</span><span class="op">$</span><span class="va">sample_type</span> <span class="op">==</span> <span class="st">"sQC"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co">## 2) Stratify by a column (e.g., batch)</span></span>
<span><span class="va">res_batch</span> <span class="op">&lt;-</span> <span class="fu">OmicsProcessing</span><span class="fu">::</span><span class="fu"><a href="../reference/remove_outliers.html">remove_outliers</a></span><span class="op">(</span></span>
<span>  <span class="va">df</span>, </span>
<span>  target_cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"f1"</span>,<span class="st">"f2"</span>,<span class="st">"f3"</span><span class="op">)</span>,</span>
<span>  is_qc <span class="op">=</span> <span class="va">df</span><span class="op">$</span><span class="va">sample_type</span> <span class="op">==</span> <span class="st">"sQC"</span>,</span>
<span>  strata <span class="op">=</span> <span class="st">"batch"</span>,</span>
<span>  return_ggplots <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co">## 3) Stratify by an external vector</span></span>
<span><span class="va">grp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">center</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"C1"</span>,<span class="st">"C2"</span><span class="op">)</span>, <span class="st">"C12"</span>, <span class="st">"C3"</span><span class="op">)</span></span>
<span><span class="va">res_grp</span> <span class="op">&lt;-</span> <span class="fu">OmicsProcessing</span><span class="fu">::</span><span class="fu"><a href="../reference/remove_outliers.html">remove_outliers</a></span><span class="op">(</span></span>
<span>  <span class="va">df</span>, </span>
<span>  target_cols <span class="op">=</span> <span class="fu">tidyselect</span><span class="fu">::</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">starts_with</a></span><span class="op">(</span><span class="st">"feat_"</span><span class="op">)</span>,</span>
<span>  is_qc <span class="op">=</span> <span class="va">df</span><span class="op">$</span><span class="va">sample_type</span> <span class="op">==</span> <span class="st">"sQC"</span>,</span>
<span>  strata <span class="op">=</span> <span class="va">grp</span>,</span>
<span>  restore_missing_values <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="implementation-notes-requirements">Implementation notes &amp; requirements<a class="anchor" aria-label="anchor" href="#implementation-notes-requirements"></a>
</h3>
<ul>
<li>
<strong>PCA:</strong> implemented via
<code><a href="https://rdrr.io/r/stats/prcomp.html" class="external-link">stats::prcomp()</a></code>.</li>
<li>
<strong>LOF distances:</strong> computed with
<code><a href="https://rdrr.io/pkg/bigutilsr/man/LOF.html" class="external-link">bigutilsr::LOF()</a></code>.</li>
<li>
<strong>Outlier thresholding:</strong> via
<code><a href="https://rdrr.io/pkg/bigutilsr/man/tukey_mc_up.html" class="external-link">bigutilsr::tukey_mc_up()</a></code>.</li>
</ul>
<p>Practical constraints:</p>
<ul>
<li>You must have <strong>enough non-QC samples per stratum</strong> for
PCA and LOF to be meaningful. Very small strata (e.g., &lt; ~8–10
samples) may yield unstable or invalid LOF results.</li>
<li>Features in <code>target_cols</code> should be
<strong>numeric</strong>, with <strong>no infinite values</strong>;
missing values are handled by the optional imputation step but
<strong>constant/zero-variance features</strong> can break PCA.</li>
<li>LOF requires a number of neighbors (<code>K</code>); if a stratum
has too few samples relative to <code>K</code>, <code>LOF()</code> may
error or degenerate. As a rule of thumb, ensure
<strong><code>n_samples_stratum &gt;&gt; K</code></strong>.</li>
<li>Very high <strong>p/n ratios</strong> (many more features than
samples) can make PCA and LOF unstable. Consider filtering features
before running this step.</li>
<li>
<strong>ggplot generation requires at least 10 feature
columns</strong> in <code>target_cols</code>. If fewer than 10 are
provided, plots cannot be generated; in such cases you should leave
<code>return_ggplots = FALSE</code> (the default).</li>
</ul>
<p><strong>Returned values</strong></p>
<ul>
<li>
<code>df_filtered</code>: input <code>df</code> with detected
outlier <strong>non-QC</strong> rows removed (QC rows always
retained).</li>
<li>
<code>excluded_ids</code>: vector of removed row names (union across
strata).</li>
<li>
<code>plot_samples_outlier</code>: <code>NULL</code> or a
<strong>named list of ggplot objects</strong> (one per stratum) when
<code>return_ggplots = TRUE</code> <em>and</em>
<code>length(target_cols) &gt;= 10</code>.</li>
</ul>
</div>
<div class="section level3">
<h3 id="how-lof-works-in-pca-space-extra-detail">How LOF works in PCA space (extra detail)<a class="anchor" aria-label="anchor" href="#how-lof-works-in-pca-space-extra-detail"></a>
</h3>
<p>Outliers are identified using the Local Outlier Factor (LOF)
algorithm applied in PCA-reduced space. LOF detects locally sparse
samples relative to their neighbours, improving data consistency and
reducing technical noise.</p>
<p><strong>Extended description:</strong> LOF is a density-based
algorithm that compares the local density of each point to that of its
neighbours. It first finds the <em>k</em> nearest neighbours (typically
by Euclidean distance) and computes each point’s <strong>local
reachability density (LRD)</strong>—the inverse of the average
reachability distance that reflects local crowding. Points in dense
regions have high LRD; points in sparse regions have low LRD. The
<strong>LOF score</strong> is the ratio of the neighbours’ average LRD
to the point’s LRD; values near 1 indicate typical density, while values
well above 1 signal local sparsity and potential outliers.</p>
<p>When LOF runs in <strong>PCA space</strong> (e.g., first 10 principal
components), it assesses local density in a reduced subspace capturing
the dominant structure and variance. This projection trims noise and
redundancy from correlated features, improving robustness and
efficiency. Samples with high LOF scores are locally isolated relative
to the main patterns in the reduced space—indicating they may be
biologically, technically, or experimentally unusual rather than random
fluctuations.</p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Vivian Viallon, Lee Matthew, Ali Farnudi.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
